#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright 2018-present ScyllaDB
#

#
# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import sys
import argparse
from subprocess import run
from scylla_util import *

if __name__ == '__main__':
    if os.getuid() > 0:
        print('Requires root permission.')
        sys.exit(1)
    parser = argparse.ArgumentParser(description='Configure cpuset configuration for Scylla.')
    parser.add_argument('--cpuset',
                        help='CPUs to use (in cpuset(7) format; default: all))')
    parser.add_argument('--smp',
                        help='number of threads (default: one per CPU)')
    args = parser.parse_args()
    if not args.cpuset and not args.smp:
        parser.print_help()
        sys.exit(1)

    cpuset = smp = None
    conf = seastar_conf()
    if conf.has_option('cpuset'):
        cpuset = conf.get('cpuset')
    if conf.has_option('smp'):
        smp = conf.get('smp')
    if cpuset != args.cpuset or smp != args.smp:
        if os.path.exists('/etc/scylla.d/perftune.yaml'):
            run(f'{scriptsdir()}/scylla_perftune_setup --regenerate', shell=True, check=True)

        conf.update_with_args(args)
        conf.commit()
