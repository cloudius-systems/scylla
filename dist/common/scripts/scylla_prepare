#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright 2018-present ScyllaDB
#

#
# SPDX-License-Identifier: AGPL-3.0-or-later

import os
import sys
import platform

from scylla_util import *
from subprocess import run

def verify_cpu():
    if platform.machine() == 'x86_64':
        needed_flags = set(['sse4_2', 'pclmulqdq'])
        for line in open('/proc/cpuinfo'):
            if line.startswith('flags'):
                actual_flags = set(line.split()[2:])
                missing_flags = needed_flags - actual_flags
                if len(missing_flags) > 0:
                    print(f"ERROR: You will not be able to run Scylla on this machine because its CPU lacks the following features: {' '.join(missing_flags)}")
                    print('\nIf this is a virtual machine, please update its CPU feature configuration or upgrade to a newer hypervisor.')
                    sys.exit(1)

if __name__ == '__main__':
    verify_cpu()

    try:
        if os.path.exists('/etc/scylla.d/perftune.yaml'):
            run("/opt/scylladb/scripts/perftune.py --options-file /etc/scylla.d/perftune.yaml", shell=True, check=True)
    except Exception as e:
        print(f'Exception occurred while tuning system using perftune.yaml:\n')
        traceback.print_exc()
        print('\nTo fix the error, please re-run scylla_setup.')
        sys.exit(1)
