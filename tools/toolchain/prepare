#!/bin/bash -e

bv=$(buildah --version)
if (( $? != 0 )); then
    echo install buildah 1.19.3 or later
    exit 1
fi

# translate to array of version components
bv="${bv#buildah version }"
bv="${bv% (*}"
bv=(${bv//./ })

maj=${bv[0]}
min=${bv[1]}
patch=${bv[2]}

ok=$(( maj > 1 || ( maj == 1 && min > 19 ) || ( maj == 1 && min == 19 && patch >= 3 ) ))

if (( ! ok )); then 
    echo install buildah 1.19.3 or later
    exit 1
fi

archs=(amd64 arm64)

# docker arch has a diffrent spelling than uname arch
declare -A arch_unames=(
    [amd64]=x86_64
    [arm64]=aarch64
    [s390x]=s390x
)

for arch in "${archs[@]}"; do
    # translate from docker arch to uname arch
    arch_uname="${arch_unames[$arch]}"
    if [[ "$(uname -m)" == "${arch_uname}" ]]; then
        continue
    fi
    if [[ ! -f  /proc/sys/fs/binfmt_misc/qemu-"${arch_uname}" ]]; then
        echo install qemu-user-static
        exit 1
    fi
done

usage() {
    cat <<EOF

Options:
  --clang_install          build and install an optimized clang compiler binary.
  --clang_build <host dir> build an optimized clang compiler binary and keep in the host directory
  --help                   this help snippet
EOF
    exit 1
}

CLANG_CMD="--build-arg CLANG_BUILD=SKIP"
while [ $# -gt 0 ]; do
    case "$1" in
        "--clang_install")
	    CLANG_CMD="--build-arg CLANG_BUILD=INSTALL"
            shift 1
            ;;
        "--clang_build")
	    CLANG_CMD="--build-arg CLANG_BUILD=BUILD -v $2:/optimized_clang:Z"
            shift 2
            ;;
        "--help")
            usage
            ;;
    esac
done

buildah bud "${archs[@]/#/--platform=linux/}" --jobs 0 --squash --no-cache --pull -f tools/toolchain/Dockerfile --manifest "$(<tools/toolchain/image)" ${CLANG_CMD}

echo "Done building $(<tools/toolchain/image). You can now test it, and push with"
echo ""
echo "    podman manifest push --all $(<tools/toolchain/image) docker://$(<tools/toolchain/image)"
